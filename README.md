# Система принятия ставок на события

## Содержание

1. [Стек технологий](#стек-технологий)
2. [Назначение проекта](#назначение-проекта)
3. [Основная информация по использованию API](#основная-информация-по-использованию-api)
4. [Установка и запуск](#установка-и-запуск)
5. [Автор](#автор)

## Стек технологий

- **Python**: 3.10.12
- **FastAPI**: 0.115.6
- **aio-pika**: 9.5.4
- **Хранилище кеша**: redis:alpine (БД для сервиса line_provider)
- **База данных**: PostgreSQL 17
- **RabbitMQ**: 3-management-alpine

## Назначение проекта

Система предназначена для обработки ставок на события и состоит из двух взаимосвязанных сервисов,
обеспечивающих надёжность и масштабируемость.

### 1. Сервис Bet Maker

**Bet Maker** — это API, предназначенное для приёма ставок от пользователей. Основные функции сервиса:

**Валидация данных**: проверка корректности формата ставок и их соответствия установленным временным ограничениям.

**Проверка наличия событий**: для каждой ставки запрашиваются данные о событиях из сервиса Line Provider.

В качестве базы данных для сервиса используется **PostgreSQL**, обеспечивающая надёжное хранение информации о ставках.

Дополнительно, для повышения производительности, реализован локальный кэш с использованием **TTLCache**.
Это позволяет хранить данные о событиях в памяти, минимизируя обращения к сервису **Line Provider** при повторных запросах.

### 2. Сервис Line Provider

**Line Provider** — это API, отвечающее за создание и управление событиями в системе.
Оно предоставляет функционал для добавления новых событий, их обновления и управления их статусами.

Для хранения данных о событиях используется **Redis**,
что позволяет добиться высокой скорости обработки запросов и гибкости при управлении данными.

**Связь между сервисами:**

Оба сервиса взаимодействуют через асинхронную очередь сообщений, реализованную с использованием **RabbitMQ**.
Очередь выполняет ключевую роль в синхронизации данных между сервисами обеспечивая передачу статусов событий 
от **Line Provider** к **Bet Maker**, и автоматически обновляя статусы ставок в зависимости от изменения статусов событий.

## Основная информация по использованию API

### 1. Bet Maker:

В системе по её старту предусмотрено автоматическое создание пользователя, чтобы эндпоинты не оставались без защиты.
Данные для создания пользователя берутся из файла **.env**.

Запрос для получения токена:

POST /token

```json
{
  "username": "test",
  "password": "test"
}
```

Ответ:

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJzdHJpbmciLCJleHAiOjE3MzczODg2NTR9.sQBSGucvZ_78iBywngrRsLDbOw_1uQC_UpFhVVCOhnw",
  "token_type": "bearer"
}
```

Данный токен передаётся как Bearer токен при запросах, срок жизни токена указывать в **.env**.
Внутри документации по адресу http://localhost:8000/docs авторизация происходит через интерфейс.

### 2. Line Provider

Сервис запущен по адресу http://localhost:8001/. 
Для обращения к эндпоитам данного сервиса в качестве Bearer токена необходимо использовать переменную
LINE_PROVIDER_TOKEN.
Внутри эндпоинта на создание события в системе в качестве данных для поля deadline использовать timestamp. Так же
внутрь данного эндпоинта можно передать только лишь коэффициент, в таком случае время дедлайна проставится автоматически
как
текущее время + 5000 секунд, чего вполне достаточно для тестов.

Создание события:

GET /event

```json
{
  "coefficient": 1.45,
  "deadline": 1737074286
}
```

Или без deadline:

```json
{
  "coefficient": 3.67
}
```

Ответ:

```json
{
  "event_id": 1,
  "coefficient": 1,
  "deadline": 1737178310,
  "state": 1,
  "create_date": 1737173310,
  "update_date": 1737173310
}
```

Остальные эндпоинты сервиса можно посмотреть по адресу http://localhost:8001/docs

## Установка и запуск

Клонировать репозиторий и перейти в него:

```
git clone https://github.com/Alex386386/bid_system.git
cd bid_system/
```

Создайте файл **.env** в корне проекта со следующим содержанием:

```
# Данные PostgreSQL
DB_ENGINE=postgresql+asyncpg
DB_NAME=postgres
POSTGRES_USER=postgres
POSTGRES_PASSWORD=qwertyytrewq
DB_HOST=manager_db
DB_PORT=5432
DATABASE_URL="postgresql+asyncpg://postgres:qwertyytrewq@manager_db:5432/postgres"

# Данные для создания первого пользователя в системе
FIRST_USER_USERNAME="string"
FIRST_USER_EMAIL="example@example.com"
FIRST_USER_PASSWORD="string"
FIRST_USER_NAME="string"

# Данные формирования токенов внутри Bet_maker
SECRET_KEY="secret-variable"
ALGORITHM="HS256"
TOKEN_EXPIRED_MINUTES=3600

# Данные формирования локального кэша внутри Bet_maker
CACHE_MAX_SIZE=100
CACHE_TTL=60

# Данные Redis
REDIS_PASSWORD=7634823476
REDIS_CONNECT_URL=redis://:7634823476@line_redis:6379/0
REDIS_HASH_NAME="redis_hash_name"
MAX_ID_KEY="max_id_key" # Переменнная для сохранения максимального id в Redis.

# Данные для работы с Line_provider
EVENT_URL="http://line_provider:8000/events"
MINIMUM_EVENT_DURATION=5000
LINE_PROVIDER_TOKEN="f3fb8928bad49887d2089f5ad04c2cb634bb1980db77fc8c3b111edad34f4eb7"

# Данные для работы с RabbitMQ
RABBITMQ_URL="amqp://guest:guest@bet_rabbitmq:5672/"
RABBIT_HOST="bet_rabbitmq"
RABBIT_PORT=5672
RABBIT_QUEUE="event_status_updates"
```

Данные можно оставить без изменений или заменить на свои.

Запустить проект:

```
sudo docker compose --env-file .env up --build
```

Для наглядности работы системы уровень логирования установлен на DEBUG.
Так же для упрощения все логи записываются в поток исполнения.

## Автор

- [Александр Мамонов](https://github.com/Alex386386) 
